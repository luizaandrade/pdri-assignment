```{r}

devtools::install_github('bbc/bbplot')

packages <-
  c(
    "here",
    "tidyverse",
    "skimr",
    "lubridate",
    "assertthat",
    "lfe",
    "vtable",
    "sjlabelled",
    "bbplot",
    "huxtable"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

# Background
In January 2012, the Cook County State’s Attorney’s Office established a program intended to reduce re-arrest among people on bail awaiting trial. The program ran through October 2013. The SA’s Office asked you to evaluate the effectiveness of the program and provided the data described below.

# Data
There are four datasets: case.csv, demo.csv, prior_arrests.csv, and grades.csv. prior_arrests.csv  Finally, grades.csv includes 9th and 10th grade course grades for a subset of individuals in case.csv. Further description of the datasets is included at the end of this document.

## Cases

The main dataset and reflects dates of arrest and disposition (trial or court appearance) during the period in which the program operated. The file also contains an indicator of whether the arrestee was referred to the intervention program for that arrest (i.e. whether they were treated), whether the person was re- arrested while awaiting trial, the number of prior arrests at the time of program entry, and the arrest location.

```{r}
cases <-
  read.csv(
    here(
      "data",
      "raw",
      "case.csv"
    )
  )

skim(cases)
```

- Key: `caseid` 
- Foreign keys: `person_id`
- Dates: `arrest_date`, `dispos_rate`
- Text: `address`
- Dummies: `treat`, `re_arrest``
- Numeric: `prior_arrests`

```{r}
cases <-
  cases %>%
  mutate(
    across(
      ends_with("date"),
      ~ as_date(.)
    ),
    across(
      c(treat, re_arrest),
      ~ as.logical(.)
    ),
    address = str_to_upper(address)
  )

skim(cases)
```

```{r}
cases %>%
  select(
    caseid,
    person_id
  ) %>%
  summarise(
    across(
      everything(),
      n_distinct
    )
  )
```

```{r}
write_rds(
  cases,
  here(
    "data",
    "clean",
    "case.rds"
  )
)
```


## Demographic characteristics

Contains demographic information about arrestees, including some who were not included in the program evaluation.

```{r}
demo <-
  read.csv(
    here(
      "data",
      "raw",
      "demo.csv"
    )
  )

skim(demo)

head(demo)
```

- Key: `person_id`
- Factors: `race`, `gender`
- Date: `bdate`

```{r}
demo <-
  demo %>%
  mutate(
    across(
      c(race, gender),
      ~ as_factor(.)
    ),
    bdate = as_date(bdate)
  )

skim(demo)
```

- There are three categories in race: BLACK, WHITE, and ASIAN
- There are four categories in gender: M, F, Male and Female
- There are `r demo %>% select(person_id) %>% n_distinct` unique values in `person_id`, meaning there are duplicate entries

Are the duplicate values coming from multiple entries of the same individual, or are there discrepancies in the values of the variables for a given ID?

```{r}
demo %>% unique %>% nrow
```

Remove duplicate entries
```{r}
demo <-
  demo %>%
  unique
```

Clean categories

```{r}
demo <-
  demo %>%
  mutate(
    gender =
      gender %>%
      fct_recode(
        "male" = "M",
        "female" = "F"
      ),
    across(
      c(race, gender),
      ~ str_to_title(.) %>%
        as_factor
    )
  )
```

```{r}
demo %>%
  ggplot(
    aes(gender)
  ) +
  geom_bar()
```

```{r}
demo %>%
  ggplot(
    aes(race)
  ) +
  geom_bar()
```

```{r}
demo %>%
  ggplot(
    aes(bdate)
  ) +
  geom_histogram()
```


```{r}
demo %>%
  write_rds(
    here(
      "data",
      "clean",
      "demo.rds"
    )
  )
```

## Prior arrests

reflects pre-period arrests among individuals in case.csv; the pre-period ran from 2008-2011.

```{r}
prior_arrests <-
  read.csv(
    here(
      "data",
      "raw",
      "prior_arrests.csv"
    )
  )

skim(prior_arrests)
```

- There are `r prior_arrests %>% select(person_id) %>% n_distinct` unique person ids
- There are `r prior_arrests %>% unique %>% nrow` unique observations, meaning there are duplicate entries. This could be because a person was arrested more than once on the same day or because the same arrest is recorded twice in the data.


```{r}
prior_arrests <-
  prior_arrests %>%
  mutate(
    arrest_date = as_date(arrest_date)
  )
```

```{r}
prior_arrests %>%
  ggplot(
    aes(arrest_date)
  ) +
  geom_histogram()
```

- Should go only until 2011

```{r}
prior_arrests %>%
  group_by(
    person_id, arrest_date
  ) %>%
  mutate(
    count = n()
  ) %>%
  filter(count > 1) %>%
  arrange(count, person_id, arrest_date)
```

Should this match??
```{r}
prior_arrests %>%
  group_by(person_id) %>%
  summarise(
    n_arrests = n()
  ) %>%
  left_join(
    cases
  ) 
```


```{r}
prior_arrests %>%
  write_rds(
    here(
      "data",
      "clean",
      "prior_arrests.rds"
    )
  )
```


## Grades
```{r}
grades <-
  read.csv(
    here(
      "data",
      "raw",
      "grades.csv"
    )
  )

skim(grades)

grades %>%
  write_rds(
    here(
      "data",
      "clean",
      "grades.rds"
    )
  )
```

