```{r}
packages <-
  c(
    "here",
    "tidyverse",
    "skimr",
    "lubridate",
    "assertthat",
    "lfe",
    "vtable"
  )

pacman::p_load(
  packages,
  character.only = TRUE
)
```

# Background
In January 2012, the Cook County State’s Attorney’s Office established a program intended to reduce re-arrest among people on bail awaiting trial. The program ran through October 2013. The SA’s Office asked you to evaluate the effectiveness of the program and provided the data described below.

# Data
There are four datasets: case.csv, demo.csv, prior_arrests.csv, and grades.csv. prior_arrests.csv  Finally, grades.csv includes 9th and 10th grade course grades for a subset of individuals in case.csv. Further description of the datasets is included at the end of this document.

## Cases

The main dataset and reflects dates of arrest and disposition (trial or court appearance) during the period in which the program operated. The file also contains an indicator of whether the arrestee was referred to the intervention program for that arrest (i.e. whether they were treated), whether the person was re- arrested while awaiting trial, the number of prior arrests at the time of program entry, and the arrest location.

```{r}
cases <-
  read.csv(
    here(
      "data",
      "raw",
      "case.csv"
    )
  )

skim(cases)
```

- Key: `caseid` 
- Foreign keys: `person_id`
- Dates: `arrest_date`, `dispos_rate`
- Text: `address`
- Dummies: `treat`, `re_arrest``
- Numeric: `prior_arrests`

```{r}
cases <-
  cases %>%
  mutate(
    across(
      ends_with("date"),
      ~ as_date(.)
    ),
    across(
      c(treat, re_arrest),
      ~ as.logical(.)
    ),
    address = str_to_upper(address)
  )

skim(cases)
```

```{r}
cases %>%
  select(
    caseid,
    person_id
  ) %>%
  summarise(
    across(
      everything(),
      n_distinct
    )
  )
```

```{r}
write_rds(
  cases,
  here(
    "data",
    "clean",
    "case.rds"
  )
)
```


## Demographic characteristics

Contains demographic information about arrestees, including some who were not included in the program evaluation.

```{r}
demo <-
  read.csv(
    here(
      "data",
      "raw",
      "demo.csv"
    )
  )

skim(demo)

head(demo)
```

- Key: `person_id`
- Factors: `race`, `gender`
- Date: `bdate`

```{r}
demo <-
  demo %>%
  mutate(
    across(
      c(race, gender),
      ~ as_factor(.)
    ),
    bdate = as_date(bdate)
  )

skim(demo)
```

- There are three categories in race: BLACK, WHITE, and ASIAN
- There are four categories in gender: M, F, Male and Female
- There are `r demo %>% select(person_id) %>% n_distinct` unique values in `person_id`, meaning there are duplicate entries

Are the duplicate values coming from multiple entries of the same individual, or are there discrepancies in the values of the variables for a given ID?

```{r}
demo %>% unique %>% nrow
```

Remove duplicate entries
```{r}
demo <-
  demo %>%
  unique
```

Clean categories

```{r}
demo <-
  demo %>%
  mutate(
    gender =
      gender %>%
      fct_recode(
        "male" = "M",
        "female" = "F"
      ),
    across(
      c(race, gender),
      ~ str_to_title(.) %>%
        as_factor
    )
  )
```

```{r}
demo %>%
  ggplot(
    aes(gender)
  ) +
  geom_bar()
```

```{r}
demo %>%
  ggplot(
    aes(race)
  ) +
  geom_bar()
```

```{r}
demo %>%
  ggplot(
    aes(bdate)
  ) +
  geom_histogram()
```


## Prior arrests

reflects pre-period arrests among individuals in case.csv; the pre-period ran from 2008-2011.

```{r}
prior_arrests <-
  read.csv(
    here(
      "data",
      "raw",
      "prior_arrests.csv"
    )
  )

skim(prior_arrests)
```

- There are `r prior_arrests %>% select(person_id) %>% n_distinct` unique person ids
- There are `r prior_arrests %>% unique %>% nrow` unique observations, meaning there are duplicate entries. This could be because a person was arrested more than once on the same day or because the same arrest is recorded twice in the data.


```{r}
prior_arrests <-
  prior_arrests %>%
  mutate(
    arrest_date = as_date(arrest_date)
  )
```

```{r}
prior_arrests %>%
  ggplot(
    aes(arrest_date)
  ) +
  geom_histogram()
```

- Should go only until 2011

```{r}
prior_arrests %>%
  group_by(
    person_id, arrest_date
  ) %>%
  mutate(
    count = n()
  ) %>%
  filter(count > 1) %>%
  arrange(count, person_id, arrest_date)
```

Should this match??
```{r}
prior_arrests %>%
  group_by(person_id) %>%
  summarise(
    n_arrests = n()
  ) %>%
  left_join(
    cases
  ) 
```




## Grades
```{r}
grades <-
  read.csv(
    here(
      "data",
      "raw",
      "grades.csv"
    )
  )

skim(grades)
```

# Construction

Include demographic data

```{r}
data <-
  cases %>%
  left_join(
    demo,
    by = "person_id"
  )

skim(data)
```

> no missings in race and gender

Restrict sample to individuals arrested in Chicago

While the program was mostly rolled out to defendants in Chicago, the State’s Attorney’s Office also ran a pilot serving a small number of individuals arrested in other parts of Cook County. For the purpose of this analysis, please restrict the data to only individuals who were arrested in Chicago.

CHECK THAT THE ADDRESS IS THE ADDRESS OF THE ARREST

```{r}
data <-
  data %>%
  separate(
    address, 
    sep = ", ",
    into = c("st_address", "city")
  ) %>%
  mutate(
    city = str_to_title(city)
  )

skim(data$city)
```

```{r}
data %>%
  ggplot(
    aes(city)
  ) +
  geom_bar()
```

```{r}
data <-
  data %>%
  filter(city == "Chicago")
```

Create an age variable equal to the defendant’s age at the time of arrest for each case.

```{r}
data <-
  data %>%
  mutate(
    age = (bdate %--% arrest_date) / years(1)
  )
```

The State’s Attorney is interested in pursuing a partnership with the Chicago Public Schools to investigate the relationship between high school achievement and criminal justice outcomes in early adulthood. To that end, the State’s Attorney’s Office has requested 9th and 10th grade course grade data from defendants between the ages of 18 and 24. These data are included in grades.csv. Please construct measures for 9th and 10th grade GPA for this target population. When constructing GPA, please use a 4 point scale, where: A=4, B=3, C=2, D=1, and F=0.

GPA definition: by term?

```{r}
gpa_wide <-
  grades %>%
  mutate(
    across(
      gr9_fall_math:gr10_spring_hist,
      ~ case_when(
        . == "F" ~ 0,
        . == "D" ~ 1,
        . == "C" ~ 2,
        . == "B" ~ 3,
        . == "A" ~ 4
      )
    )
  )

gpa_long <-
  gpa_wide %>%
  pivot_longer(
    cols = gr9_fall_math:gr10_spring_hist,
    names_pattern = "gr(.*)_(.*)_(.*)",
    names_to = c("grade", "term", "subject"),
    values_to = "score"
  )

gpa <-
  gpa_long %>%
  group_by(person_id, grade) %>%
  summarise(gpa = mean(score, na.rm = TRUE)) %>%
  pivot_wider(
    id_cols = person_id,
    names_from = grade,
    names_prefix = "gpa_gr",
    values_from = gpa
  )

data <-
  data %>%
  left_join(
    gpa,
    by = "person_id"
  )

```

Weirdly enough, when we combine the datasets, the defendants age 18 to 24 are the only ones that we do not have GPA for


3.
a. The provided case.csv file includes a variable that indicates the number of arrests prior to that case for each individual. Please reconstruct the variable using the prior_arrests.csv file. Assume that all of the individual’s arrests prior to the study period are contained in prior_arrest.csv. If someone is not included in prior_arrests.csv, assume they had zero arrests at the start of the study period. Also note that some individuals were arrested multiple times during the study period and that this should be accounted for in your prior arrest count. For example, if individual A was arrested 5 times prior to the study period and appears twice in the case file, their first arrest in the case file should have a prior arrest count of “5” and their second arrest should have a prior arrest count of “6”. One final note, some people really do get arrested multiple times on the same day. Count each arrest separately, regardless of whether another arrest occurred on the same day.

if two arrests on the same day, we don't know how many were before or after, so counting by day

```{r}

prior_arrests <-
  prior_arrests %>%
  group_by(person_id) %>%
  summarise(preperiod_arrests = n())

case_arrests <-
  cases %>%
  select(
    person_id,
    date = arrest_date
  ) %>%
  full_join(
    cases %>%
      select(
        person_id,
        caseid,
        arrest_date,
        dispos_date
      ),
    by = "person_id"
  ) %>%
  mutate(
    prior_arrest = date < arrest_date,
    re_arrest = date > arrest_date & date < dispos_date
  )

check <-
  case_arrests %>%
  group_by(caseid, person_id) %>%
  summarise(
    prior_arrest = sum(prior_arrest, na.rm = TRUE),
    re_arrest = max(re_arrest) %>% as.logical()
  ) %>%
  full_join(
    prior_arrests,
    by = "person_id"
  ) %>%
  mutate(prior_arrests = prior_arrest + preperiod_arrests %>% replace_na(0))

check <-
  cases %>%
  select(
    caseid,
    person_id,
    prior_arrests,
    re_arrest
  ) %>%
  left_join(
    check,
    by = c("caseid", "person_id")
  ) %>%
  arrange(
    caseid, person_id
  )

re_arrest_check <-
  check %>%
  filter(re_arrest.x != re_arrest.y) %>%
  group_by(person_id) %>%
  summarise(count = n()) 

table(re_arrest_check$count)

prior_arrest_check <-
  check %>%
  filter(prior_arrests.x != prior_arrests.y) %>% 
  group_by(person_id) %>%
  summarise(in_prior_arrests = is.na(preperiod_arrests) %>% all)


table(prior_arrest_check$in_prior_arrests)
```


b. The case file also includes a variable re_arrest which indicates whether individuals were arrested during their case period (i.e. after the case’s arrest date and before the case’s disposition date). Please reconstruct this indicator. Assume that all arrests during the study period are reflected in the case file.

c. Please show that the variables you reconstructed are equal to the versions in the provided datasets.

# Part 3: Statistical Analysis


Help the State’s Attorney’s Office determine if the program should be continued/expanded by estimating the program’s effect on re-arrests prior to disposition. Because we only have grades data for young adults, please do not use these data to inform your statistical analysis. To draw conclusions about this program’s effect, answer the following questions.

1. Describe the demographic characteristics of the study population based on the data available to you. (Hint: the study population has 25,000 subjects).

a. Are the treatment and control groups balanced (on race, gender, etc.), or are there differences in the composition of the two groups? Please present your answer in the form of a table.

```{r}
data %>%
  transmute(
    treat = treat,
    black = (race == "Black") * 1,
    white = (race == "White") * 1,
    asian = (race == "Asian") * 1,
    gender = (gender == "Female") * 1,
    age = age,
    prior_arrests = prior_arrests
  ) %>%
  balance_table("treat")

data %>%
  select(
    treat,
    prior_arrests,
    race,
    gender,
    age
  ) %>%
  sumtable(group = "treat", group.test = TRUE)
```

b. Choose one observable characteristic and visualize the difference between those who were enrolled in the program and those who were not.

```{r}
ggplot(data) +
  aes(
    x = age,
    color = treat
  ) +
  geom_density()
```

3. Did participating in the program reduce the likelihood of re-arrest before disposition? Explain your answer and your methodology.

```{r}
skim(data$re_arrest %>% as.numeric())
reg <-
  felm(re_arrest ~ treat + age + prior_arrests | gender | 0 | 0,
     data)

summary(reg)
```

4. The State’s Attorney’s Office is interested in expanding the program if it is shown to reduce re-arrest. However, they do not have the budget to serve every individual on bail awaiting trial. In order to make best use of their restricted budget, they would like to target the individuals most likely to benefit from the program. Using the data available to you, what recommendation would you make regarding who to serve?


```{r}
skim(data$re_arrest %>% as.numeric())

reg <-
  felm(re_arrest ~ treat + age + prior_arrests,
     data %>% filter(gender == "Female"))

summary(reg)

reg <-
  felm(re_arrest ~ treat + age + prior_arrests,
     data %>% filter(gender == "Male"))

summary(reg)

reg <-
  felm(re_arrest ~ treat + age + prior_arrests,
     data %>% filter(race == "Asian"))

summary(reg)

reg <-
  felm(re_arrest ~ treat + age + prior_arrests,
     data %>% filter(race == "Black"))

summary(reg)

reg <-
  felm(re_arrest ~ treat + age + prior_arrests,
     data %>% filter(race == "White"))

summary(reg)

reg <-
  felm(re_arrest ~ treat + age,
     data %>% filter(prior_arrests == FALSE))

summary(reg)

reg <-
  felm(re_arrest ~ treat + age,
     data %>% filter(prior_arrests == TRUE))

summary(reg)
```